<!doctype html>
<html lang="hr">
  <div id="sheetData"></div>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fantazisti Liga 25/26</title>
  <style>
    :root{
      --bg1:#120016;
      --bg2:#3b0a5a;
      --accent:#8b5cf6; /* svjetlija ljubičasta */
      --muted:#bcb3d9;
      --card-bg: rgba(255,255,255,0.03);
      --glass: rgba(255,255,255,0.03);
      --win: #00c853;
      --lose: #ff5252;
    }
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{
      background: linear-gradient(180deg,var(--bg1),var(--bg2));
      color: #f3eefc;
      -webkit-font-smoothing:antialiased;
      -webkit-text-size-adjust:100%;
      background-attachment:fixed;
    }
    /* subtle background image (replace url with preferred) */
    body::after{
      content:"";
      position:fixed;left:0;top:0;right:0;bottom:0;
      background-image: url('https://images.unsplash.com/photo-1531058020387-3be344556be6?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s='); /* placeholder stadium */
      background-size:cover;
      background-position:center;
      opacity:0.07;
      pointer-events:none;
      mix-blend-mode:screen;
    }

    .container{max-width:1200px;margin:28px auto;padding:20px;display:grid;grid-template-columns:1fr 420px;gap:20px;}
    header{grid-column:1/-1;display:flex;align-items:center;gap:16px}
    .logo{
      width:72px;height:72px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#6d28d9);
      display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;box-shadow:0 8px 30px rgba(0,0,0,0.6);
    }
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .card{background:var(--card-bg);border-radius:12px;padding:12px;box-shadow: 0 6px 18px rgba(0,0,0,0.5);backdrop-filter: blur(4px);border:1px solid rgba(255,255,255,0.03);}
    /* leaderboard */
    .leaderboard{display:flex;flex-direction:column;gap:10px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{position:sticky;top:0;background:linear-gradient(90deg, rgba(0,0,0,0.25), rgba(255,255,255,0.02));padding:8px;text-align:left;font-size:12px;color:var(--muted)}
    tbody td{padding:10px;border-top:1px dashed rgba(255,255,255,0.03)}
    .rank{width:44px;font-weight:700}
    .team{display:flex;gap:8px;align-items:center}
    .avatar{width:34px;height:34px;border-radius:50%;background:rgba(255,255,255,0.06);display:inline-flex;align-items:center;justify-content:center;font-size:12px}
    .progress.up{color:var(--win)}
    .progress.down{color:var(--lose)}

    /* google sheet area */
    .sheet-frame{height:640px;overflow:auto;padding:6px}
    .sheet-table{width:100%;border-collapse:collapse;font-size:13px}
    .sheet-table th{position:sticky;top:0;background:rgba(0,0,0,0.4);padding:6px;text-align:left;color:var(--muted)}
    .sheet-table td{padding:8px;border-top:1px solid rgba(255,255,255,0.03)}

    footer{grid-column:1/-1;text-align:center;color:var(--muted);font-size:13px;margin-top:6px}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
    .small{font-size:12px;color:var(--muted)}
    @media(max-width:980px){
      .container{grid-template-columns:1fr; padding:12px}
      .sheet-frame{height:380px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">F25/26</div>
      <div>
        <h1>Fantazisti Liga 25/26</h1>
        <p class="lead">Prijateljska liga fanatičnih zaljubljenika Premierlige — live poredak i tablica isplata</p>
      </div>
      <div style="margin-left:auto" class="controls">
        <button id="refreshBtn" class="btn">Refresh</button>
        <div class="small" id="lastUpdated">—</div>
      </div>
    </header>

    <!-- LEFT: Leaderboard -->
    <section class="card leaderboard" id="leaderboardCard">
      <h3 style="margin:0 0 6px 0">Liga — poredak</h3>
      <div style="overflow:auto">
        <table id="fplTable">
          <thead>
            <tr>
              <th class="rank">#</th>
              <th>Tim</th>
              <th>Menadžer</th>
              <th style="width:80px">GW</th>
              <th style="width:90px">Ukupno</th>
              <th style="width:85px">Promjena</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="6" style="padding:18px;color:var(--muted)">Učitavanje...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- RIGHT: Google sheet -->
    <aside class="card">
      <h3 style="margin:0 0 6px 0">Igrači + nagrade 25/26</h3>
      <div class="sheet-frame" id="sheetFrame">
        <table class="sheet-table" id="sheetTable">
          <thead></thead>
          <tbody><tr><td style="color:var(--muted)">Učitavanje Google Sheeta...</td></tr></tbody>
        </table>
      </div>
      <div style="margin-top:8px;text-align:right">
        <a id="openSheet" class="btn" target="_blank" rel="noopener">Otvori u Google Sheets</a>
      </div>
    </aside>

    <footer class="small">Automatsko osvježavanje: svake 60s • Host: GitHub Pages (static) • Ako je potrebno, mogu podesiti proxy radi CORS</footer>
  </div>

<script>
/* CONFIG - prilagodi po potrebi */
const LEAGUE_ID = '631473'; // već imamo
const SHEET_ID = '1rD6wKaivqevoBNAuqvRzmS9YHORqeItGFjKOKrXDJLU';
const SHEET_GID = '1223070779'; // iz linka
const REFRESH_INTERVAL_MS = 60 * 1000; // 60s

const fplEndpoint = `https://fantasy.premierleague.com/api/leagues-classic/${LEAGUE_ID}/standings/`;
const sheetCsvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;

const fplTableBody = document.querySelector('#fplTable tbody');
const sheetTable = document.getElementById('sheetTable');
const lastUpdatedEl = document.getElementById('lastUpdated');
document.getElementById('openSheet').href = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit#gid=${SHEET_GID}`;

async function fetchFPL(){
  try{
    const res = await fetch(fplEndpoint, {cache: "no-store"});
    if(!res.ok) throw new Error('FPL API status ' + res.status);
    const json = await res.json();
    // DEBUG: console.log(json);
    const results = (json.standings && json.standings.results) ? json.standings.results : (json.results || []);
    renderFPL(results);
  }catch(err){
    console.error('FPL fetch error', err);
    fplTableBody.innerHTML = `<tr><td colspan="6" style="color:var(--muted);padding:12px">Ne mogu dohvatiti FPL poredak. Mogući CORS ili mrežni problem.</td></tr>`;
  }
}

function renderFPL(rows){
  if(!rows || rows.length===0){
    fplTableBody.innerHTML = `<tr><td colspan="6" style="color:var(--muted);padding:12px">Nema podataka.</td></tr>`;
    return;
  }
  // render top N (prikaži sve ili ograniči)
  const html = rows.map(r=>{
    // Polja u FPL API: entry_name, player_name, total, rank, event_total, movement (ili thing like last_rank)
    const rank = r.rank ?? r.position ?? r.overall_rank ?? '';
    const team = r.entry_name ?? r.player_name ?? 'team';
    const manager = r.player_name ?? r.entry_name ?? '';
    const total = (r.total !== undefined) ? r.total : (r.overall !== undefined ? r.overall : '');
    const gw = (r.event_total !== undefined) ? r.event_total : (r.last_event_points !== undefined ? r.last_event_points : '');
    // movement/rank change: some endpoints use 'movement' or 'rank_sort' or 'last_rank'
    const movement = (r.movement ?? (r.last_rank ? ( (r.last_rank - rank) * -1 ) : 0));
    const movClass = (movement > 0) ? 'up' : (movement < 0 ? 'down' : '');
    const movText = (movement > 0) ? `▲ ${Math.abs(movement)}` : (movement < 0 ? `▼ ${Math.abs(movement)}` : '-');

    // avatar: if exists r.entry && r.entry.player_first_name? fallback to initials
    const initials = team.split(' ').slice(0,2).map(s=>s[0]).join('').toUpperCase();

    return `<tr>
      <td class="rank">${rank}</td>
      <td><div class="team"><div class="avatar">${initials}</div><div><div style="font-weight:600">${escapeHtml(team)}</div></div></div></td>
      <td>${escapeHtml(manager)}</td>
      <td style="text-align:right">${gw ?? '-'}</td>
      <td style="text-align:right">${total ?? '-'}</td>
      <td class="progress ${movClass}" style="text-align:right">${movText}</td>
    </tr>`;
  }).join('');
  fplTableBody.innerHTML = html;
  lastUpdatedEl.textContent = 'Ažurirano: ' + new Date().toLocaleTimeString();
}

/* simple CSV parser for public sheet (handles simple CSVs) */
function parseCSV(csv){
  const lines = csv.split(/\r?\n/).filter(l=>l.trim().length>0);
  const rows = lines.map(line => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(cell=>{
    // remove surrounding quotes
    cell = cell.trim();
    if(cell.startsWith('"') && cell.endsWith('"')) cell = cell.slice(1,-1);
    return cell;
  }));
  return rows;
}

async function fetchSheet(){
  try{
    const res = await fetch(sheetCsvUrl, {cache: "no-store"});
    if(!res.ok) throw new Error('Sheet status ' + res.status);
    const text = await res.text();
    const rows = parseCSV(text);
    renderSheet(rows);
  }catch(err){
    console.error('Sheet fetch error', err);
    document.querySelector('#sheetTable tbody').innerHTML = `<tr><td style="color:var(--muted);padding:12px">Ne mogu dohvatiti Google Sheet. Provjeri da je "Anyone with the link - Viewer".</td></tr>`;
  }
}

function renderSheet(rows){
  if(!rows || rows.length===0){
    sheetTable.querySelector('tbody').innerHTML = `<tr><td style="color:var(--muted);padding:12px">Prazan sheet</td></tr>`;
    return;
  }
  // header
  const header = rows[0].map(h=>`<th>${escapeHtml(h)}</th>`).join('');
  const body = rows.slice(1).map(r=>`<tr>${r.map(c=>`<td>${escapeHtml(c)}</td>`).join('')}</tr>`).join('');
  sheetTable.querySelector('thead').innerHTML = `<tr>${header}</tr>`;
  sheetTable.querySelector('tbody').innerHTML = body;
}

function escapeHtml(s){
  if(s === null || s === undefined) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* init + refresh loop */
async function refreshAll(){
  await Promise.allSettled([fetchFPL(), fetchSheet()]);
}

document.getElementById('refreshBtn').addEventListener('click', ()=>refreshAll());

refreshAll();
setInterval(refreshAll, REFRESH_INTERVAL_MS);

</script>
  <script>
async function loadSheet() {
    const url = "https://docs.google.com/spreadsheets/d/1rD6wKaivqevoBNAuqvRzmS9YHORqeItGFjKOKrXDJLU/export?format=csv";

    const response = await fetch(url);
    const csv = await response.text();

    const rows = csv.split("\n").map(r => r.split(","));

    let html = "<table border='1' style='border-collapse: collapse; margin-top:20px;'>";

    rows.forEach(row => {
        html += "<tr>";
        row.forEach(cell => {
            html += `<td style='padding:4px;'>${cell}</td>`;
        });
        html += "</tr>";
    });

    html += "</table>";

    document.getElementById("sheetData").innerHTML = html;
}

loadSheet();
</script>

</body>
</html>

